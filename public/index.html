<!DOCTYPE html>
<html>
<head>
	<script src="vis/vis.min.js"></script>
	<link href="vis/vis.min.css" rel="stylesheet" type="text/css" />
</head>

<body>
<div>
	Input a course:<br>
	<select id="subject-selector" name="subject" onchange="loadCourses()"></select>
	<select id="course-selector" name="courseID" onchange="loadGraph()"></select>
	<Button type="button" onClick="loadGraph()"> Graph! </Button><br>
	<div id="visualization"></div>
</div>

<script type="text/javascript">
	//Main
	loadSubjects();

	//Handle click from html button
	function loadGraph() {
		let subject = document.getElementById('subject-selector').value;
		let courseID = document.getElementById('course-selector').value;
		sendRequest('/getGraph?subject=' + subject + '&courseID=' + courseID, function(datalist) {
			drawGraph(JSON.parse(datalist));
		});
	}

	//Load courses to subject selector
	function loadSubjects() {
		let selector = document.getElementById('subject-selector');
		selector.innerHTML = null;

		sendRequest('/getSubjects', function(list) {
			let subjectList = JSON.parse(list);
			for (let i = 0; i < subjectList.length; i++) {
				let course = subjectList[i];
				let option = document.createElement('option');
				option.setAttribute('value', course);
				option.innerText = course;
				selector.appendChild(option);
			}
			loadCourses(subjectList[0]);
		});
	}

	//Load courses to course selector
	function loadCourses() {
		let subject = document.getElementById('subject-selector').value;
		let selector = document.getElementById('course-selector');
		selector.innerHTML = null;

		sendRequest('/getCourses?subject=' + subject, function(list) {
			let courseList = JSON.parse(list);
			for (let i = 0; i < courseList.length; i++) {
				let course = courseList[i];
				let option = document.createElement('option');
				option.setAttribute('value', course);
				option.innerText = course;
				selector.appendChild(option);
			}
			loadGraph();
		});
	}

	//Function to send server request
	function sendRequest(url, callback) {
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function() {
			if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
				callback(xmlHttp.responseText);
		}
		xmlHttp.open("GET", url, true); // true for asynchronous
		xmlHttp.send(null);
	}

	function drawGraph(datalist) {
		var container = document.getElementById('visualization');
		container.innerHTML = null;

		var items = [];
		for (let i = 0; i < datalist.length; i++) {

			if (i == 0)
				items.push({x: i, y: datalist[i], group: 0, label: {content: 'Pass1', yOffset: -10}});

			if (i < 8)
				items.push({x: i, y: datalist[i], group: 0});

			if (i == 8)
				items.push({x: i, y: datalist[i], group: 0, label: {content: 'Pass2', yOffset: -10}});

			if (i >= 8 && i < 19)
				items.push({x: i, y: datalist[i], group: 1});

			if (i == 19)
				items.push({x: i, y: datalist[i], group: 1, label: {content: 'Pass3', yOffset: -10}});

			if (i >= 19)
				items.push({x: i, y: datalist[i], group: 2});

		}

		var dataset = new vis.DataSet(items);
		var options = {
			zoomable: false,
			width: '100%',
			height: '300px',
			dataAxis: {
				left: {
					range: {
						min: 0, max: 1.1
					},
					format: (value) => (value * 100 + '%')
				}
			},
			shaded: {
				enabled: true
			}
		};

		var graph2d = new vis.Graph2d(container, dataset, options);
	}

</script>

</body>
</html>
